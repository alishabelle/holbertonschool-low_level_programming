Dealing with more nested loops